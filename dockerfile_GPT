# syntax=docker/dockerfile:1

# ======================================================
# Base image
# ======================================================
FROM python:3.12-slim

# ======================================================
# Environment (Cloud Run + Python behavior)
# ======================================================
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PORT=8080

# Streamlit (avoid prompts + bind on all interfaces)
ENV STREAMLIT_SERVER_PORT=8080
ENV STREAMLIT_SERVER_ADDRESS=0.0.0.0
ENV STREAMLIT_BROWSER_GATHER_USAGE_STATS=false

# Matplotlib cache in writable path
ENV MPLCONFIGDIR=/tmp/matplotlib

# Kaleido / browser hints (works with Chromium on Debian slim)
ENV BROWSER=chromium

# ======================================================
# System dependencies
# - LaTeX toolchain (latexmk + TeX Live)
# - Ghostscript (PDF handling)
# - Chromium + runtime libs (Plotly/Kaleido export)
# - Fonts (stable text rendering)
# ======================================================
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        git \
        build-essential \
        ghostscript \
        latexmk \
        texlive \
        texlive-latex-extra \
        texlive-fonts-recommended \
        texlive-lang-portuguese \
        texlive-bibtex-extra \
        biber \
        chromium \
        chromium-driver \
        libglib2.0-0 \
        libnss3 \
        libx11-6 \
        libxrender1 \
        libxext6 \
        libsm6 \
        libfontconfig1 \
        libfreetype6 \
        libpng16-16 \
        libjpeg62-turbo \
        fonts-dejavu \
        fonts-liberation \
    && rm -rf /var/lib/apt/lists/*

# ======================================================
# App user (non-root)
# ======================================================
RUN useradd -m -u 10001 appuser
WORKDIR /app
USER appuser

# ======================================================
# Python dependencies
# ======================================================
COPY --chown=appuser:appuser requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir --upgrade pip \
    && pip install --no-cache-dir -r /app/requirements.txt

# ======================================================
# Copy application
# ======================================================
COPY --chown=appuser:appuser . /app

# ======================================================
# Cloud Run expects the container to listen on $PORT
# ======================================================
EXPOSE 8080

# ======================================================
# Run
# ======================================================
CMD ["streamlit", "run", "main.py", "--server.port=8080", "--server.address=0.0.0.0"]
